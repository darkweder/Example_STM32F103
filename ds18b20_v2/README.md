Работа с датчиком температуры DS18B20

Сначала в датчик отправляется команда на преобразование температуры, на отправку этой команды уходит ~2мс, основной цикл программы зависает на это время.
На преобразование температуры, датчику нужно 750мс (12-ти битный режим), чтоб не ждать это время, запускается таймер (TIM4), основной цик продолжает работать.
По истечении 750мс, в датчик отправляется команда на считывание данных, и происходит приём этих данных. На это требуется ~3мс, основной цикл программы снова зависает на это время.

```
while (1)
{
  if(flag == 1)
  {
	  flag = 0;
	  ds18b20_getTemperature(); // зависаем на ~2мс
  }
  else if(flag == 2) // когда таймер отсчитает 750мс, он установит flag == 2
  {
      flag = 0;
      
	  int16_t temp = resTemperature(); // зависаем на ~3мс

	  float t = temp / 16.0;
	  char str[32] = {0,};

	  snprintf(str, 32, "Temp dec: %d\n", temp / 16);
	  HAL_UART_Transmit(&huart1, (uint8_t*)str, strlen(str), 1000);

	  snprintf(str, 32, "Temp float: %.2f\n", t);
	  HAL_UART_Transmit(&huart1, (uint8_t*)str, strlen(str), 1000);
	  
	  flag = 1; // запускаем новое измерение. Можно делать это где-то в другом месте, в зависимости от того, как часто нужно производить измерения
  }
```


---------------------------------------------------------------
В CubeMX настроить любой пин как GPIO_Output, например **PB5**


GPIO Output Level - Low

GPIO mode - Output Open Drain

GPIO Pull-up/Pull-down - No pull-up and no pull-down

Maximum output speed - High

-------------------------------------------------------
В файле ds18b20.c прописать этот пин...

#define MY_PORT **GPIOB**

#define MY_PIN  **GPIO_PIN_5**

-------------------------------------------------------


![](https://github.com/stDstm/Example_STM32F103/blob/master/ds18b20/cubemx2.png)

 
